function init(){aG={},lmG={},require(["esri/config","dojo/on","dojo/dom-construct","dojo/text!./scripts/_config/config.json","esri/dijit/Legend","mesa/toolsWidget2"],function(esriConfig,on,domConstruct,JSONconfig,Legend){JSONconfig=JSON.parse(JSONconfig),aG.popup=setPopup(1===checkForMobile()?"mobile":"static"),esriConfig.defaults.io.proxyUrl=JSONconfig.proxyURL,esriConfig.defaults.io.alwaysUseProxy=!1,esriConfig.defaults.geometryService=createGeometryService(JSONconfig.geometryService),document.dojoClick=!1;var utm12=setSpatialRef(102206),initExtent=setInitialExtent(utm12);aG.map=createMap(initExtent),aG.pTemp=createPopupTemplate(),lmG.pLay=createFeatureLayer("http://mcmap2.mesacounty.us/arcgis/rest/services/maps/ParcelOnly4Query/MapServer/0"),lmG.roadLabels=createTiledMapServiceLayer("http://mcmap2.mesacounty.us/arcgis/rest/services/maps/parcel_road_labels/MapServer","roadLabels"),lmG.vectorBasemap=createTiledMapServiceLayer("http://mcmap2.mesacounty.us/arcgis/rest/services/maps/vector_basemap/MapServer","vectorBasemap");var initialBasemap=lmG.vectorBasemap;aG.map.addLayers([lmG.vectorBasemap,lmG.pLay,lmG.roadLabels]),aG.map.on("load",function(){createScalebar(aG.map),createContextMenu(aG.map,JSONconfig.geometryService);var node=domConstruct.toDom("<div data-to='mainSideMenu' class='displayNo legendMenu' id='legendDiv'></div>");domConstruct.place(node,document.body,"after");var legend=new Legend({map:aG.map},node);runToolsView(JSONconfig.geometryService,JSONconfig.printURL,aG.map,aG.popup,aG.pTemp,legend),createHomeButton(aG.map),setEventHandlers(JSONconfig,aG.map,lmG.pLay,initialBasemap,lmG.roadLabels,aG.popup,aG.pTemp,legend),document.getElementById("loading").style.display="none",aG.map.disableKeyboardNavigation(),location.href.indexOf("?")>-1&&urlMapType(location.href,aG.map,legend)})})}function setEventHandlers(JSONconfig,map,parcelLayerObject,initialBasemap,roadLabels,popupObject,popupTemplateObject,legendObject){require(["dojo/on","dojo/query","dojo/dom","dojo/touch","mesa/themeTools"],function(on,query,dom,touch,themeTools){window.addEventListener("orientationchange",orientationChanged,!1),map.on("mouse-move",function(e){showCoords(e,"screenCoordinatesUTM")}),on(dom.byId("menuSelect"),"click",function(legendObject){runToolsView()}),on(dom.byId("help"),touch.release,function(e){showHelp(e,JSONconfig.printURL)}),on(dom.byId("shareMap"),touch.release,function(){showShareForm(map)}),on(query("#DTprint"),touch.release,function(){showPrinter(map,JSONconfig.printURL)}),on(query("#DTbookmarks"),touch.release,function(){showBookmarks(map)}),on(query("#DTqueryatts"),touch.release,function(){showQuery(map,JSONconfig.geometryService)}),on(query("#DTmeasure"),touch.release,function(){showMeasure(map,parcelLayerObject,JSONconfig.geometryService)}),on(query("#DTbasemap,#IPbasemap"),touch.release,function(){showBasemap(map,JSONconfig.imagesList,initialBasemap)}),on(query(".shareClass, #sharebutton"),touch.release,function(){showShare("socialShare")}),on(query("#layerSelect ul li"),touch.release,function(e){themeTools.themeClick(e,this,map,popupObject,popupTemplateObject,legendObject)}),on(query(".plus"),touch.release,clickPlus),on(query(".baselyrs"),"click",function(e){baseLayersSwitch(e,parcelLayerObject,initialBasemap,roadLabels)}),on(dom.byId("hidePanel"),"click",themeTools.animatePanel),on(dom.byId("locate"),touch.release,function(){showLocator(JSONconfig.geometryService)}),on(query(".submen li, .submenu li"),touch.release,function(){var classname="."+this.parentNode.className;query(classname)[0].style.display="none"}),on(query("#combobox, #mainfish"),"mouseenter, mouseleave, touchstart",function(e){var display="mouseleave"===e.type?"none":"block",classname="."+query("#"+this.id+" ul")[0].className;query(classname)[0].style.display=display}),on(query("#searchLI ul li"),touch.release,function(e){e.stopPropagation();var type=this.getAttribute("data-value");dom.byId("searchLI").childNodes[0].nodeValue=this.childNodes[0].innerHTML,require(["dijit/registry","mesa/searchTools"],function(registry,searchTools){registry.byId("searchFieldDialog")&&registry.byId("searchFieldDialog").destroyRecursive(),searchTools.searchBy(type,void 0,"desktop")})})})}function createTiledMapServiceLayer(url,id){var tile;return require(["esri/layers/ArcGISTiledMapServiceLayer"],function(ArcGISTiledMapServiceLayer){tile=new ArcGISTiledMapServiceLayer(url,{id:id})}),tile}function createFeatureLayer(url){var service;return require(["esri/layers/FeatureLayer"],function(FeatureLayer){service=new FeatureLayer(url,{mode:FeatureLayer.MODE_ONDEMAND,infoTemplate:aG.pTemp,outFields:["LOCATION","ACCOUNTNO","OWNER","JTOWNER","SDATE","PARCEL_NUM","ZONING","Acres","JURISDICTION"]})}),service}function createGeometryService(serviceURL){var service;return require(["esri/tasks/GeometryService"],function(GeometryService){service=new GeometryService(serviceURL)}),service}function createPopupTemplate(){var temp;return require(["esri/dijit/PopupTemplate"],function(PopupTemplate){temp=new PopupTemplate({fieldInfos:[{fieldName:"Acres",visible:!0,format:{places:2}}],title:"<b>Parcel Information:</b>",description:"<b>Account number:</b>  <a href='http://emap.mesacounty.us/assessor_lookup/Assessor_Parcel_Report.aspx?Account={ACCOUNTNO}'target='_blank'>{ACCOUNTNO}</a><br><b>Parcel Number:</b> {PARCEL_NUM}<br><b>Owner:</b>  {OWNER}<br><b>Joint Owner:</b>  {JTOWNER}<br><b>Address:</b>{LOCATION}<br><b>Sale Date:</b> {SDATE}<br><b>Zoning:</b> {ZONING}<br><b>Approximate Acres:</b> {Acres}<br><b>Jurisdiction: </b>{JURISDICTION}<br><div id='mapButtons'><a title='Click to view parcel in Google Earth' class='maplink' target='_blank' href='http://emap.mesacounty.us/kmls?acct={ACCOUNTNO}'>Google Earth</a><a title='Click to view parcel in Bing Maps' class='maplink' target='_blank' href='http://www.bing.com/maps/?mapurl=http://emap.mesacounty.us/kmls?acct={ACCOUNTNO}'>Bing Maps</a></div><br>"})}),temp}function createMap(initExtent){var map;return require(["esri/map"],function(Map){map=new Map("map",{extent:initExtent,logo:!1,infoWindow:aG.popup})}),map}function setInitialExtent(spatialRef){var ext;return require(["esri/geometry/Extent"],function(Extent){ext=new Extent({xmin:685960,ymin:4316261,xmax:738288,ymax:4342506,spatialReference:spatialRef})}),ext}function setSpatialRef(wkid){var ref;return require(["esri/SpatialReference"],function(SpatialReference){ref=new SpatialReference({wkid:wkid})}),ref}function setPopup(type){var pop;return"mobile"===type?require(["dojo/dom","esri/dijit/PopupMobile"],function(dom,PopupMobile){pop=PopupMobile(null,dom.byId("popup"))}):require(["esri/dijit/Popup"],function(Popup){pop=Popup({titleInBody:!1},document.getElementById("popup"))}),pop}function checkForMobile(){var isMobile;return require(["dojo/has","dojo/sniff"],function(has,sniff){has.add("mobile",function(global,document,anElement){return has("ie")?void require(["libs/matchMedia"],function(){return!(!window.matchMedia("only screen and (max-width: 1024px)").matches||!has("touch"))}):!(!window.matchMedia("only screen and (max-width: 1024px)").matches||!has("touch"))}),isMobile=has("mobile")?1:0}),isMobile}function runToolsView(geometryService,printURL,map,popupObject,popupTemplateObject,legendObj){require(["dijit/registry","mesa/toolsWidget2"],function(registry,toolsWidget){if(registry.byId("toolsView2"))"block"===registry.byId("toolsView2").domNode.style.display?registry.byId("toolsView2").domNode.style.display="none":registry.byId("toolsView2").domNode.style.display="block";else{new toolsWidget({geometryServiceURL:geometryService,printURL:printURL,mapRef:map,popupRef:popupObject,popupTemplateRef:popupTemplateObject,legendRef:legendObj},"toolsView2");registry.byId("toolsView2").domNode.style.display="none"}})}function orientationChanged(){require(["dojo/query"],function(query){query(".expandedPanel")[0]&&(query(".expandedPanel")[0].style.display="none")})}function showShare(id){document.getElementById(id).style.display="block"===document.getElementById(id).style.display?"none":"block"}function makeBoxesMoveable(){require(["dojo/dnd/move","dojo/query","dojo/dom"],function(move,query,dom){for(i=0,len=query(".moveableDialog");i<len.length;i++)move.parentConstrainedMoveable(dom.byId(len[i].id),{handle:query("#"+len[i].id+" > header"),area:"margin",within:!0});new move.parentConstrainedMoveable(dom.byId("popup"),{handle:dom.byId("popup"),area:"margin",within:!0})})}function createHomeButton(map){require(["mesa/homeButton"],function(homeButton){homeButton({mapRef:map})})}function createContextMenu(map,geometryServiceConfig){require(["mesa/contextMenuWidget"],function(contextMenuWidget){contextMenuWidget({mapRef:map,geometryServiceURL:geometryServiceConfig,trsURL:"http://mcmap2.mesacounty.us/arcgis/rest/services/maps/eSurveyor/MapServer/26"})})}function createImageList(imageConfig){require(["esri/layers/ArcGISTiledMapServiceLayer"],function(ArcGISTiledMapServiceLayer){for(var x in imageConfig.images)lmG[imageConfig.images[x].imageId]=new ArcGISTiledMapServiceLayer(imageConfig.mapFolder+imageConfig.images[x].serviceName+imageConfig.serverType,{id:imageConfig.images[x].imageId})})}function createScalebar(map){require(["esri/dijit/Scalebar"],function(Scalebar){new Scalebar({map:map,attachTo:"bottom-right",scalebarUnit:"dual"})})}function toggleDialog(dialogId){require(["dojo/dom","dojo/dom-class"],function(dom,domClass){domClass.contains(dom.byId("legendDialog"),"displayNo")?(dom.byId("legendDialog").style.display="block",domClass.remove(dom.byId("legendDialog"),"displayNo")):(dom.byId("legendDialog").style.display="none",domClass.add(dom.byId("legendDialog"),"displayNo"))})}function showPrinter(map,printURL){require(["mesa/printWidget","dojo/dom-construct","dojo/dom","dojo/on","dijit/registry","dojo/dom-style"],function(printWidget,domConstruct,dom,on,registry,domStyle){if(!registry.byId("printDialog2")){var printer=new printWidget({printUrl:printURL,mapRef:map,device:"desktop"},"printDialog2");printer.startup()}domStyle.set(dom.byId("printDialog2"),{display:"block"===domStyle.get(dom.byId("printDialog2"),"display")?"none":"block"})})}function showBookmarks(map){require(["dijit/registry","mesa/bookmarkWidget","dojo/dom"],function(registry,bookmarkWidget,dom){if(!registry.byId("bookmarkDialog2")){var bookmarks=new bookmarkWidget({mapRef:map},"bookmarkDialog2");bookmarks.startup()}dom.byId("bookmarkDialog2")&&(dom.byId("bookmarkDialog2").style.display="block"===dom.byId("bookmarkDialog2").style.display?"none":"block")})}function showHelp(e,printURL){e.preventDefault(),require(["mesa/helpWidget","dojo/dom-construct","dojo/dom","dojo/on","dijit/registry","dojo/dom-style"],function(helpWidget,domConstruct,dom,on,registry,domStyle){if(dom.byId("helpMenu2")&&!registry.byId("helpMenu2")){var help=new helpWidget({printUrl:printURL,device:"desktop"},"helpMenu2");help.startup()}dom.byId("helpMenu2")&&domStyle.set(dom.byId("helpMenu2"),{display:"block"===domStyle.get(dom.byId("helpMenu2"),"display")?"none":"block"})})}function showQuery(map,geometryServiceURL){require(["dojo/dom","dijit/registry","mesa/queryWidget"],function(dom,registry,queryWidget){if(dom.byId("queryDialog2")&&!registry.byId("queryDialog2")){var queryTool=new queryWidget({device:"desktop",mapRef:map,geometryServiceURL:geometryServiceURL,exportURL:"scripts/php/toCSV.php",csvOutputLocation:"scripts/php/"},"queryDialog2");queryTool.startup()}dom.byId("queryDialog2")&&(dom.byId("queryDialog2").style.display="block"===dom.byId("queryDialog2").style.display?"none":"block")})}function showBasemap(map,imageConfig,initialBasemap){require(["dijit/registry","mesa/basemapWidget"],function(registry){registry.byId("imagelist2")||(createImageList(imageConfig),lmG.imageTool=new basemapWidget({mapRef:map,device:"desktop",initialBasemap:initialBasemap},"imagelist2")),lmG.imageTool.basemapChanger()})}function showShareForm(map){require(["mesa/shareFormWidget","dijit/registry","dojo/dom"],function(shareFormWidget,registry,dom){if(!registry.byId("shareForm2")){var shareForm=new shareFormWidget({emailServiceUrl:"scripts/php/ShareMail.php",mapRef:map},"shareForm2");shareForm.startup()}dom.byId("shareForm2")&&(dom.byId("shareForm2").style.display="block"===dom.byId("shareForm2").style.display?"none":"block")})}function showMeasure(map,parcelLayer,geometryService){require(["mesa/measureWidget","dojo/dom","dojo/on","dijit/registry"],function(measureWidget,dom,on,registry){if(dom.byId("measureDialog2")&&!registry.byId("measureDialog2")){var measure=new measureWidget({mapRef:map,gsvc:geometryService,device:"desktop",parcelLayer:parcelLayer},"measureDialog2");measure.startup()}dom.byId("measureDialog2")&&(dom.byId("measureDialog2").style.display="block"===dom.byId("measureDialog2").style.display?"none":"block")})}function showLocator(geometryServiceURL){require(["mesa/locatorWidget","dojo/dom","dojo/on","dijit/registry"],function(locatorWidget,dom,on,registry){var locate=new locatorWidget({mapRef:aG.map,gsvc:geometryServiceURL,device:"desktop"});locate.startup()})}function showCoords(evt,id){document.getElementById(id).innerHTML="X="+evt.mapPoint.x.toFixed(1)+"  Y="+evt.mapPoint.y.toFixed(1)}function extentZoom(extentObject){var viewExtent;return require(["esri/geometry/Extent","esri/SpatialReference"],function(Extent,SpatialReference){var utm12=new SpatialReference({wkid:102206}),ext=extentObject.split(":"),xmini=parseInt(ext[0]),ymini=parseInt(ext[1]),xmaxi=parseInt(ext[2]),ymaxi=parseInt(ext[3]);viewExtent=new Extent({xmin:xmini,ymin:ymini,xmax:xmaxi,ymax:ymaxi,spatialReference:utm12})}),viewExtent}function baseLayersSwitch(e,ParcelLayerObject,basemapObject,roadLabelObject){require(["dojo/query","dojo/dom-attr"],function(query,domAttr){var target=e.target?e.target:e.srcElement,thisClassName=domAttr.get(target,"class");thisClassName="input."+thisClassName.split(" ").pop();var baselayers=query(".expand")[0],box=query(thisClassName),layers={"input.pclcbx":ParcelLayerObject,"input.lbsgcbx":basemapObject,"input.bgcbx":roadLabelObject};for(i=0;i<box.length;i++)box[i].checked=!!target.checked;if(baselayers.checked)for(var x in layers)query(x)[0].checked?layers[x].show():layers[x].hide();else for(var x in layers)layers[x].hide()})}function clickPlus(e){require(["dojo/query","dojo/dom-attr","dojo/dom-style","dojo/dom-class","dojo/NodeList-traverse","dojo/NodeList-manipulate"],function(query,domAttr,domStyle,domClass){var cls=domAttr.get(e.target,"class");cls=cls.split(" ")[1],"minus"!==cls?(query(".plus").forEach(function(node){domClass.replace(node,"minus","plus")}),query(".lyrexpand").children("li").forEach(function(node){domStyle.set(node,"display","block")})):(query(".plusSign").forEach(function(node){domClass.replace(node,"plus","minus")}),query(".lyrexpand").children("li").forEach(function(node){domStyle.set(node,"display","none")}))})}function urlMapType(url,map,legend){require(["esri/urlUtils","dojo/query","dojo/NodeList-traverse","dojo/dom-attr","dojo/_base/array","dojo/NodeList-manipulate","mesa/searchTools"],function(urlUtils,query,domAttr,array,searchTools){function parseParameters(url){function createTitle(map_type){return query("#layerSelect ul li[data-value='"+map_type+"']").children("a").innerHTML()}function maptypeFound(type){return require(["mesa/themeTools"],function(themeTools){themeTools.getTemplate(type),themeTools.animatePanel("open")}),type}function runQuery(layerid,field,value){require(["esri/tasks/QueryTask","esri/tasks/query","esri/graphic","mesa/graphicsTools"],function(QueryTask,Query,Graphic,graphicsTools){var graphicTool=new graphicsTools({geometryServiceURL:esriConfig.defaults.geometryService,mapRef:map});dQueryTask=new QueryTask("http://mcmap2.mesacounty.us/arcgis/rest/services/maps/"+service+"/MapServer/"+layerid),dQuery=new Query,dQuery.returnGeometry=!0,dQuery.outFields=[""],dQuery.where=field+" = '"+value+"'",dQueryTask.execute(dQuery,function(result){map.setExtent(map.graphics.add(new Graphic(graphicTool.createJSONPolygon(result.features[0].geometry.rings))).geometry.getExtent().expand(1.5))})})}var queryObject=urlUtils.urlToObject(url).query;if(queryObject){var maptype=queryObject.maptype?maptypeFound(queryObject.maptype.toLowerCase()):void 0,title=queryObject.maptype?createTitle(maptype):"Select Map",layerid=queryObject.layerid?queryObject.layerid:void 0,checkboxid=queryObject.cbxid?queryObject.cbxid.toLowerCase().split(","):void 0,field=queryObject.field?String(queryObject.field).toUpperCase():void 0,value=queryObject.value?queryObject.value:void 0,service=queryObject.service?queryObject.service:void 0,coordinates=queryObject.latlon?queryObject.latlon:void 0,accountNumber=queryObject.ACCOUNTNO?queryObject.ACCOUNTNO.toUpperCase():void 0,parcelNumber=queryObject.PARCEL_NUM?queryObject.PARCEL_NUM.replace(/-/g,""):void 0,extent=queryObject.EXTENT?queryObject.EXTENT.toUpperCase():void 0,params=[maptype,title,layerid,value,checkboxid];void 0!==coordinates&&searchTools.searchBy("Latitude/Longitude",coordinates),void 0!==field&&runQuery(layerid,field,value),void 0!==accountNumber&&searchTools.searchBy("account",accountNumber),void 0!==parcelNumber&&searchTools.searchBy("parcelNo",parcelNumber),void 0!==extent&&map.setExtent(extentZoom(extent))}return params}var urlParams=parseParameters(url);"Select Map"!==urlParams[1]&&require(["mesa/changeTheme","dojo/dom"],function(changeTheme,dom){new changeTheme({newLayer:urlParams[0],layerTitle:urlParams[1],option:urlParams[2],pVal:urlParams[3],mapRef:map,infoWindowRef:aG.popup,infoTemplateRef:aG.pTemp,checkboxid:urlParams[4],mapLegend:legend})})})}init();