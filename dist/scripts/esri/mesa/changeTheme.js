define(["dojo/dom-construct","dojo/query","dojo/dom-attr","dojo/on","dojo/dom","esri/geometry/Extent","esri/SpatialReference","dojo/dom-style","dojo/_base/array","dijit/ConfirmDialog","dojo/cookie","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","mesa/IdentifyTemplates","esri/layers/ArcGISDynamicMapServiceLayer","mesa/legendWidget","dijit/registry","dojo/text!./_config/config.json","dojo/_base/declare","dijit/_WidgetBase","dojo/NodeList-dom","dojo/domReady!"],function(domConstruct,query,domAttr,on,dom,Extent,SpatialReference,domStyle,array,ConfirmDialog,cookie,IdentifyTask,IdentifyParameters,IdentifyTemplates,ArcGISDynamicMapServiceLayer,legendWidget,registry,JSONConfig,declare,_WidgetBase){var layer,layerTitle,option,pVal,control,changeThemeWidget,layerConstructor,themeLayers,map,basemap,checkboxClick,infoWindow,infoTemplate,checkboxids,Legend;return declare("changeTheme",[_WidgetBase],{newLayer:null,layerTitle:null,option:null,mapRef:null,basemapRef:null,infoWindowRef:null,infoTemplateRef:null,mapLegend:null,components:null,layerConstructor:null,postCreate:function(){changeThemeWidget=this,map=changeThemeWidget.mapRef,infoWindow=changeThemeWidget.infoWindowRef,infoTemplate=changeThemeWidget.infoTemplateRef,layer=changeThemeWidget.newLayer,layerTitle=changeThemeWidget.layerTitle,option=changeThemeWidget.option,pVal=void 0===changeThemeWidget.components?null:changeThemeWidget.components.pVal,basemap=changeThemeWidget.basemapRef,Legend=changeThemeWidget.mapLegend,JSONConfig=JSON.parse(JSONConfig),layerConstructor=JSONConfig.layerConstructor,themeLayers=JSONConfig.themeLayers,checkboxids=void 0===changeThemeWidget.components?null:changeThemeWidget.components.checkboxid,control=dom.byId(layer+"Select")?layer+"Select":"noControl",checkboxids&&changeThemeWidget.autoCheckBoxes(checkboxids),on(query("."+layer+"cbx"),"change",function(e){changeThemeWidget.changeBox(),changeThemeWidget.manualCheckBoxes(e.currentTarget.id)}),changeThemeWidget.resetMap(),changeThemeWidget.addFunction(layer,themeLayers[layer].popupFunc,themeLayers[layer].service,themeLayers),changeThemeWidget.loadTheme(themeLayers)},then:function(){},autoCheckBoxes:function(boxes){function checkBox(box){dom.byId(box.replace("-","")).checked=!(box.indexOf("-")>-1)}for(var i=0;i<boxes.length;i++)checkBox(boxes[i]);checkboxids="","trans"===layer?changeThemeWidget.checkOHVDisclaimer(themeLayers):""},manualCheckBoxes:function(box){dom.byId(box).checked=!!dom.byId(box).checked},changeBox:function(){changeThemeWidget.addFunction(layer,themeLayers[layer].popupFunc,themeLayers[layer].service,themeLayers),changeThemeWidget.loadTheme(themeLayers),"survey"===layer?changeThemeWidget.setCalibZoom():"","trans"===layer?changeThemeWidget.checkOHVDisclaimer(themeLayers):""},addFunction:function(layer,name,path,Layers){for(var layers=Layers[layer].lyrs?Layers[layer].lyrs:[],checked=query("input."+layer+"cbx:checked"),len=checked.length,i=0;i<len;i++)changeThemeWidget.createLayer(Layers,domAttr.get(checked[i],"data-value")),layers.push(domAttr.get(checked[i],"data-opt"));changeThemeWidget.runIT(path,name,layers)},createLayer:function(Layers,id){if(void 0===lmG[id])for(var x in layerConstructor.layers)layerConstructor.layers[x].layerId===id&&(lmG[id]=new ArcGISDynamicMapServiceLayer(layerConstructor.mapFolder+layerConstructor.layers[x].serviceName+layerConstructor.serverType,{id:id,opacity:layerConstructor.layers[x].opacity}),layerConstructor.layers[x].visible?lmG[id].setVisibleLayers(layerConstructor.layers[x].visible):void 0,Layers[id].layerName=lmG[id])},resetMap:function(){map.infoWindow.hide(),map.infoWindow.resize(350,300),lmG.pLay.infoTemplate="",lmG.maptype="",lmG.maptype=layer,dom.byId("layerSelect").childNodes[0].nodeValue=layerTitle,query("#enterpriseSelect, #surveySelect, #demographSelect, #districtsSelect, #engdocsSelect, #landdevSelect, #politicalSelect, #schoolsSelect, #topoSelect, #floodSelect, .noLoad, #transSelect, #lawSelect, #vacantSelect").style("display","none"),dom.byId(control).style.display="block"},setCalibZoom:function(){dom.byId("calib").checked?dom.byId("calibzoom").removeAttribute("disabled","disabled"):dom.byId("calibzoom").setAttribute("disabled","disabled"),on(dom.byId("calibzoom"),"click",function(){var utm12=new SpatialReference({wkid:102206}),calibExt=new Extent({xmin:697322,ymin:4334595,xmax:698932,ymax:4335382,spatialReference:utm12});map.setExtent(calibExt)})},checkOHVDisclaimer:function(Layers){if(query(".noLoad").forEach(function(node){domStyle.set(node,"display","none")}),query("input.transcbx")[0].checked===!0?(map.addLayers([lmG.loadLabels]),query(".noLoad").forEach(function(node){domStyle.set(node,"display","block")})):query("input.transcbx")[0].checked!==!0&&void 0!==lmG.loadLabels&&map.removeLayer(lmG.loadLabels),!(query("input.transcbx")[1].checked!==!0||document.cookie.indexOf("ohvDisclaimer")>=-1&&"Accepted OHV Disclaimer"===window.localStorage.getItem("ohvDisclaimer"))){var dial=new ConfirmDialog({title:"Disclaimer",href:"_static/ohvDisclaimer.html",closable:!1,draggable:!1,style:"width:50em;margin:0 auto;color:white;background:#A59F91;padding:1em;border-radius:4px;font-size:0.75em;","class":"ohvDisclaimer",buttonOk:"Accept",ButtonCancel:"Reject",onCancel:function(){query("input.transcbx")[1].checked=!1,changeThemeWidget.loadTheme(Layers)},onExecute:function(){var useLocalStorage=changeThemeWidget.supports_local_storage();cookie.isSupported();if(useLocalStorage)window.localStorage.setItem("ohvDisclaimer","Accepted OHV Disclaimer");else{cookie("ohvDisclaimer","Accepted OHV Disclaimer",{expires:1})}}});dial.startup(),dial.show()}},loadTheme:function(Layers){function loadArray(data){var newArray=[];for(var t in data)data.hasOwnProperty(t)&&newArray.push(t);return newArray}function layerlist(){return array.map(query("input."+layer+"cbx:checked"),function(item){return item.attributes["data-value"].value})}function pushLayers(layertitle,layerlist,x){function push(title,layerName,hidelayers){mapLegendLayers.push({layer:layerName,title:title,hideLayers:hidelayers}),Legend.refresh(mapLegendLayers)}var mapLegendLayers=[];if(push("Basemap Layers",basemap,[7,12,17,22,23,24,25,26,27,28,32,35,36,37,38,39,50,51]),0===x&&0!==layerlist)for(i=0;i<layerlist.length;i++)push(layertitle,Layers[layerlist[i]].layerName,Layers[layerlist[i]].lyrs?Layers[layerlist[i]].lyrs:[]),map.reorderLayer(Layers[layerlist[i]].layerName,1);else 0===layerlist&&0!==x&&push(layertitle,Layers[x].layerName,Layers[x].lyrs?Layers[x].lyrs:[]);Legend.refresh(mapLegendLayers)}function addLayers(layerlist,x){if(0!==layerlist)for(len=layerlist.length,i=0;i<len;i++)map.addLayer(Layers[layerlist[i]].layerName);else map.addLayer(Layers[x].layerName)}function removeLayers(themeArray){function intersectArrays(firstArray,secondArray){var selected,dict={},intersected=[],arrayLength1=firstArray.length;for(i=0;i<arrayLength1;i++)dict[firstArray[i]]=!0;for(arrayLength2=secondArray.length,i=0;i<arrayLength2;i++)selected=secondArray[i],selected in dict&&intersected.push(selected);return intersected}var mappingLayers=map.layerIds,graphicsLayers=map.graphicsLayerIds,frank=intersectArrays(themeArray,mappingLayers),joe=intersectArrays(themeArray,graphicsLayers);if(0!=frank.length)for(i=0;i<frank.length;i++)map.removeLayer(map.getLayer(frank[i]));if(joe.length>0)for(var i=0;i<joe.length;i++){var mac=map.getLayer(joe[i]).id;for(var x in Layers)x===mac&&map.removeLayer(Layers[x].layerName)}}var themeArray=loadArray(Layers);removeLayers(themeArray);for(var x in Layers)x===layer&&("eassessor"===layer?(map.infoWindow=infoWindow,lmG.pLay.infoTemplate=infoTemplate,pushLayers("Basemap Layers",l=0,x=0)):"noControl"!==control?(addLayers(layerlist(),x=0),pushLayers(" ",layerlist(),x=0)):(changeThemeWidget.createLayer(Layers,x),addLayers(l=0,x),pushLayers(layerTitle,l=0,x)))},runIT:function(opt,name,lyrs){map.graphics.clear();var len=lyrs.length;lmG.pLay.infoTemplate="";var deferred;checkboxClick&&checkboxClick.remove(),checkboxClick=on(map,"click",function(evt){var IT=new IdentifyTask("https://mcgis.mesacounty.us/arcgis/rest/services/maps/"+opt+"/MapServer/"),IP=new IdentifyParameters;IP.geometry=evt.mapPoint,IP.layerOption=IdentifyParameters.LAYER_OPTION_VISIBLE,IP.returnGeometry=!1,IP.layerIds=lyrs,IP.width=map.width,IP.height=map.height,IP.mapExtent=map.extent,IP.tolerance="towers"===name?8:3,deferred=IT.execute(IP,function(){null!==name?IdentifyTemplates[name](evt,deferred,len,map,opt):null})})},supports_local_storage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}})});